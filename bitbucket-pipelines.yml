image: idreesvend/sonarscanner-flutter:latest

clone:
  depth: full

pipelines:
  pull-requests:
    '**': #this runs as default for any branch not elsewhere defined
      - step:
          name: SonarQube  PR analysis
          script:
              - flutter test --machine --coverage
              - sonar-scanner -Dsonar.projectName="$BITBUCKET_REPO_SLUG-$BITBUCKET_PR_ID" -Dsonar.projectKey="$BITBUCKET_REPO_SLUG-$BITBUCKET_PR_ID" -Dsonar.sources=. -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.login=${SONAR_TOKEN}
              
  branches:
    '{master}': # or the name of your main branch
      - step:
          name: SonarQube analysis
          script:
              - flutter test --machine --coverage
              - sonar-scanner -Dsonar.projectKey=test -Dsonar.sources=. -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.login=${SONAR_TOKEN}
                  
definitions:
  caches:
    sonar: ~/.sonar